<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="WMS_Movil.Home"
             BackgroundColor="#f8f9fa">

    <Shell.TitleView>
        <Grid>
            <Label Text="WMS Móvil" 
                   TextColor="White" 
                   FontSize="20" 
                   FontAttributes="Bold"
                   HorizontalOptions="Center" 
                   VerticalOptions="Center"/>
        </Grid>
    </Shell.TitleView>

    <Grid>
        <!-- Reemplazamos el ScrollView con RefreshView -->
        <RefreshView x:Name="RefreshView" 
                    IsRefreshing="{Binding IsRefreshing}"
                    RefreshColor="#4c51bf">
            <ScrollView>
                <StackLayout Padding="20" Spacing="25">
                    <!-- Header con nombre de usuario y la fecha actual -->
                    <Frame BackgroundColor="#4c51bf" 
                           CornerRadius="15" 
                           Padding="20"
                           HasShadow="True">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackLayout Grid.Column="0">
                                <Label Text="¡Bienvenido!"
                                       TextColor="White"
                                       FontSize="22"
                                       FontAttributes="Bold"/>
                                <Label x:Name="UserNameLabel"
                                       TextColor="White"
                                       FontSize="18"/>
                                <Label x:Name="DateLabel"
                                       TextColor="White"
                                       FontSize="14"
                                       Opacity="0.8"
                                       Margin="0,5,0,0"/>
                            </StackLayout>
                            <Image Grid.Column="1"
                                   Source="user_avatar.png"
                                   HeightRequest="60"
                                   WidthRequest="60"
                                   VerticalOptions="Center"/>
                        </Grid>
                    </Frame>

                    <!-- Sección de Preparación en Proceso con animación de entrada -->
                    <Frame BackgroundColor="White" 
                           CornerRadius="15" 
                           Padding="15"
                           Margin="0,0,0,15"
                           HasShadow="True"
                           x:Name="PrepFrame">
                        <StackLayout>
                            <StackLayout Orientation="Horizontal" Spacing="10">
                                <Image Source="hojapendiente.png"
                                       HeightRequest="30"/>
                                <Label Text="Preparación en Proceso"
                                       FontSize="18"
                                       TextColor="#2d3748"
                                       FontAttributes="Bold"
                                       VerticalOptions="Center"/>
                                <Image Source="refresh.png"
                                       HeightRequest="20"
                                       WidthRequest="20"
                                       HorizontalOptions="EndAndExpand"
                                       VerticalOptions="Center">
                                    <Image.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnRefreshTapped"/>
                                    </Image.GestureRecognizers>
                                </Image>
                            </StackLayout>

                            <BoxView HeightRequest="1" 
                                    Color="#e2e8f0" 
                                    Margin="0,10"/>

                            <!-- Hojas Pendientes -->
                            <StackLayout x:Name="HojasPendientesLayout" IsVisible="false">
                                <Label Text="{Binding ResumenPendientes}"
                                       TextColor="#4a5568"
                                       FontSize="15"/>

                                <!-- CarouselView para las hojas pendientes -->
                                <CarouselView x:Name="HojasCarousel"
                                              ItemsSource="{Binding HojasPendientes}"
                                              HeightRequest="150"
                                              PeekAreaInsets="10"
                                              Loop="False">
                                    <CarouselView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame BackgroundColor="#EDF2F7"
                                                   CornerRadius="10"
                                                   Padding="15"
                                                   Margin="5,10"
                                                   HasShadow="True">
                                                <Frame.GestureRecognizers>
                                                    <TapGestureRecognizer Tapped="OnHojaTapped"/>
                                                </Frame.GestureRecognizers>
                                                <Grid RowSpacing="10">
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>

                                                    <StackLayout Grid.Row="0"
                                                                 Orientation="Horizontal"
                                                                 Spacing="15">
                                                        <Label Text="{Binding IdPedido, StringFormat='Pedido #{0}'}"
                                                               TextColor="#2d3748"
                                                               FontAttributes="Bold"
                                                               FontSize="16"/>
                                                        <Label Text="{Binding NoHoja, StringFormat='Hoja {0}'}"
                                                               TextColor="#4a5568"
                                                               FontSize="16"/>
                                                    </StackLayout>

                                                    <!-- Barra de progreso con estilo mejorado -->
                                                    <Frame Grid.Row="1" 
                                                           Padding="0" 
                                                           CornerRadius="5" 
                                                           BorderColor="Transparent"
                                                           BackgroundColor="#e2e8f0"
                                                           HasShadow="False">
                                                        <Frame HorizontalOptions="StartAndExpand"
                                                               Padding="0"
                                                               CornerRadius="5"
                                                               BackgroundColor="{Binding ColorProgreso}"
                                                               WidthRequest="{Binding ProgresoWidth}">
                                                            <Label Text="{Binding PorcentajeProgreso, StringFormat='{0:F0}%'}"
                                                                   HorizontalOptions="Center"
                                                                   TextColor="White"
                                                                   FontSize="12"
                                                                   FontAttributes="Bold"/>
                                                        </Frame>
                                                    </Frame>

                                                    <!-- Pequeña ayuda visual para indicar que es clickeable -->
                                                    <Label Grid.Row="2"
                                                           Text="Toca para ver detalles"
                                                           TextColor="#718096"
                                                           FontSize="12"
                                                           HorizontalOptions="End"
                                                           Margin="0,5,0,0"/>
                                                </Grid>
                                            </Frame>
                                        </DataTemplate>
                                    </CarouselView.ItemTemplate>
                                </CarouselView>

                                <!-- Indicador de posición con estilo mejorado -->
                                <IndicatorView x:Name="IndicatorView"
                                             IndicatorColor="LightGray"
                                             SelectedIndicatorColor="#4c51bf"
                                             HorizontalOptions="Center"
                                             IndicatorSize="10"
                                             Margin="0,10,0,0"/>
                            </StackLayout>

                            <!-- Mensaje cuando no hay hojas pendientes -->
                            <Frame x:Name="NoHojasPendientesLabel"
                                   IsVisible="false"
                                   BackgroundColor="#EDF2F7"
                                   CornerRadius="10"
                                   Padding="15"
                                   HasShadow="False">
                                <StackLayout Orientation="Horizontal" HorizontalOptions="Center">
                                    <Image Source="info.png"
                                           HeightRequest="20"
                                           WidthRequest="20"
                                           VerticalOptions="Center"
                                           Margin="0,0,10,0"/>
                                    <Label Text="No hay hojas pendientes de preparación"
                                           TextColor="#718096"
                                           FontSize="14"
                                           VerticalOptions="Center"/>
                                </StackLayout>
                            </Frame>
                        </StackLayout>
                    </Frame>

                    <!-- Estadísticas con animación de entrada -->
                    <Grid ColumnDefinitions="*,*" 
                          RowSpacing="20" 
                          ColumnSpacing="20"
                          x:Name="StatsGrid">
                        <!-- Pedidos Pendientes -->
                        <Frame Grid.Column="0" 
                               BackgroundColor="White"
                               CornerRadius="15"
                               HasShadow="True">
                            <StackLayout Spacing="10">
                                <Image Source="PP.png"
                                       HeightRequest="50"
                                       Aspect="AspectFit"/>
                                <Label Text="Pedidos Pendientes"
                                       HorizontalOptions="Center"
                                       FontAttributes="Bold"
                                       TextColor="#2d3748"/>
                                <Label x:Name="PendientesLabel"
                                       HorizontalOptions="Center"
                                       FontSize="24"
                                       TextColor="#4c51bf"
                                       FontAttributes="Bold"/>
                                <!-- Pequeña etiqueta que muestra la tendencia -->
                                <Frame BackgroundColor="#EBF8FF" 
                                       CornerRadius="5" 
                                       Padding="8,3" 
                                       HorizontalOptions="Center"
                                       HasShadow="False">
                                    <StackLayout Orientation="Horizontal">
                                        <Image Source="trending_up.png" 
                                               HeightRequest="12" 
                                               WidthRequest="12"
                                               VerticalOptions="Center"/>
                                    </StackLayout>
                                </Frame>
                            </StackLayout>
                        </Frame>

                        <!-- Pedidos en Rechequeo -->
                        <Frame Grid.Column="1"
                               BackgroundColor="White"
                               CornerRadius="15"
                               HasShadow="True">
                            <StackLayout Spacing="10">
                                <Image Source="Rechequeo.png"
                                       HeightRequest="50"
                                       Aspect="AspectFit"/>
                                <Label Text="En Rechequeo"
                                       HorizontalOptions="Center"
                                       FontAttributes="Bold"
                                       TextColor="#2d3748"/>
                                <Label x:Name="RechequeoLabel"
                                       HorizontalOptions="Center"
                                       FontSize="24"
                                       TextColor="#4c51bf"
                                       FontAttributes="Bold"/>
                                <!-- Pequeña etiqueta que muestra la tendencia -->
                                <Frame BackgroundColor="#FEEBC8" 
                                       CornerRadius="5" 
                                       Padding="8,3" 
                                       HorizontalOptions="Center"
                                       HasShadow="False">
                                    <StackLayout Orientation="Horizontal">
                                        <Image Source="trending_down.png" 
                                               HeightRequest="12" 
                                               WidthRequest="12"
                                               VerticalOptions="Center"/>
                                    </StackLayout>
                                </Frame>
                            </StackLayout>
                        </Frame>
                    </Grid>

                    <!-- Botones de acción con animación de entrada -->
                    <StackLayout Spacing="15" x:Name="ButtonsStack">
                        <Button x:Name="BtnPendientes"
            Text="Ver Pedidos Pendientes"
            BackgroundColor="#4c51bf"
            TextColor="White"
            CornerRadius="10"
            HeightRequest="50"
            Clicked="OnPendientesClicked"
            FontAttributes="Bold"/>

                        <Button x:Name="BtnRechequeo"
            Text="Ver Pedidos en Rechequeo"
            BackgroundColor="#667eea"
            TextColor="White"
            CornerRadius="10"
            HeightRequest="50"
            Clicked="OnRechequeoClicked"
            FontAttributes="Bold"/>

                        <!-- Botón de cerrar sesión -->
                        <Button Text="Cerrar Sesión"
            BackgroundColor="Transparent"
            TextColor="#4a5568"
            BorderColor="#CBD5E0"
            BorderWidth="1"
            CornerRadius="10"
            HeightRequest="50"
            Clicked="OnLogoutClicked"
            Margin="0,20,0,0"/>
                    </StackLayout>
                </StackLayout>
            </ScrollView>
        </RefreshView>

        <Grid x:Name="LoadingOverlay" 
              IsVisible="false"
              BackgroundColor="#80000000">
            <Frame BackgroundColor="White"
                   CornerRadius="10"
                   HeightRequest="100"
                   WidthRequest="100"
                   HorizontalOptions="Center"
                   VerticalOptions="Center">
                <StackLayout>
                    <ActivityIndicator IsRunning="True"
                                     Color="#4c51bf"
                                     HeightRequest="50"
                                     WidthRequest="50"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center" />
                    <Label Text="Cargando..."
                           TextColor="#2C3E50"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                </StackLayout>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>